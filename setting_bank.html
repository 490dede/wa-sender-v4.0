<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setting Bank - Admin-Zero Only</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; background: #fdfdfd; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .preview-img { width: 100%; max-height: 250px; object-fit: contain; margin-top: 10px; border: 1px dashed #ccc; display: none; }
        .btn-save { width: 100%; padding: 15px; background: #f39c12; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .header-box { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #f39c12; padding-bottom: 10px; }
    </style>
</head>
<body>

    <div class="header-box">
        <h2>SETTING BANK & REVENUE</h2>
        <p>Admin-Zero Exclusive Access (adeali490@gmail.com)</p>
    </div>

    <div class="card">
        <form id="bankForm">
            <div class="form-group">
                <label>Upload Barcode QRIS (Image/Gambar):</label>
                <input type="file" id="qrisFile" accept="image/*">
                <img id="qrisPreview" class="preview-img">
                <input type="hidden" id="currentQrisUrl">
            </div>

            <div class="form-group">
                <label>PayPal Account (Email):</label>
                <input type="email" id="paypal" placeholder="example@paypal.com">
            </div>

            <div class="form-group">
                <label>Rekening Bank MasterVisa (Text):</label>
                <textarea id="mastervisa" rows="3" placeholder="Nama Bank - No Rekening - Atas Nama"></textarea>
            </div>

            <button type="submit" id="btnSubmit" class="btn-save">UPDATE & DISTRIBUTE TO ADMIN</button>
        </form>
        <button onclick="location.href='dashboard_admin_zero.html'" style="margin-top:15px; width:100%; background:none; border:none; color:gray; cursor:pointer;">
            Back to Dashboard / Kembali
        </button>
    </div>

    <script>
        const _supabase = supabase.createClient('https://fdvjaulucahzmmmdwkau.supabase.co', 'sb_publishable_yN4AQrZGQEH8tzhkCsLf2g_KGoakIFa');

        // Load data lama & Tampilkan Preview
        async function loadSettings() {
            const { data } = await _supabase.from('bank_settings').select('*').single();
            if (data) {
                document.getElementById('paypal').value = data.paypal_email || '';
                document.getElementById('mastervisa').value = data.mastervisa_account || '';
                if(data.qris_image_url) {
                    const img = document.getElementById('qrisPreview');
                    img.src = data.qris_image_url;
                    img.style.display = 'block';
                    document.getElementById('currentQrisUrl').value = data.qris_image_url;
                }
            }
        }

        document.getElementById('bankForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            btn.disabled = true;
            btn.innerText = "Processing... / Memproses...";

            const file = document.getElementById('qrisFile').files[0];
            let imageUrl = document.getElementById('currentQrisUrl').value;

            // 1. Jika ada file baru, upload ke Storage
            if (file) {
                const fileName = `qris_${Date.now()}`;
                const { data, error: uploadError } = await _supabase.storage
                    .from('bank-assets')
                    .upload(fileName, file);

                if (uploadError) {
                    alert("Upload Failed: " + uploadError.message);
                    btn.disabled = false;
                    return;
                }
                
                // Ambil Public URL
                const { data: publicUrl } = _supabase.storage.from('bank-assets').getPublicUrl(fileName);
                imageUrl = publicUrl.publicUrl;
            }

            // 2. Update Database
            const { error: dbError } = await _supabase
                .from('bank_settings')
                .update({
                    qris_image_url: imageUrl,
                    paypal_email: document.getElementById('paypal').value,
                    mastervisa_account: document.getElementById('mastervisa').value,
                    updated_at: new Date()
                })
                .match({ id: (await _supabase.from('bank_settings').select('id').single()).data.id });

            if (!dbError) {
                alert("Data Distributed Successfully! / Data Berhasil Didistribusikan!");
                location.reload();
            } else {
                alert("DB Error: " + dbError.message);
            }
            btn.disabled = false;
        };

        loadSettings();
    </script>
</body>
</html>
